{% extends 'base.html' %}

{% block title %}Ledgerly - Calendar{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900 transition-colors duration-300 flex items-center justify-center p-4">

    <div class="container bg-white dark:bg-gray-800 shadow-xl rounded-2xl p-6 md:p-8 w-full max-w-5xl border border-gray-200 dark:border-gray-700">
        <!-- Calendar Header -->
        <header class="flex justify-between items-center pb-6 mb-6 border-b border-gray-200 dark:border-gray-700">
            <a href="{{ prev_month_url }}" 
               class="flex items-center justify-center w-10 h-10 bg-gray-100 dark:bg-gray-700 hover:bg-blue-500 text-gray-600 dark:text-gray-300 hover:text-white rounded-lg transition-colors duration-200" 
               title="Previous Month">
                <i class="fas fa-chevron-left"></i>
            </a>
            
            <div class="text-center">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800 dark:text-gray-100 mb-1">
                    {{ current_month_name }}
                </h1>
                <p class="text-gray-600 dark:text-gray-400 text-sm">Your Financial Journey</p>
            </div>
            
            <a href="{{ next_month_url }}" 
               class="flex items-center justify-center w-10 h-10 bg-gray-100 dark:bg-gray-700 hover:bg-blue-500 text-gray-600 dark:text-gray-300 hover:text-white rounded-lg transition-colors duration-200" 
               title="Next Month">
                <i class="fas fa-chevron-right"></i>
            </a>
        </header>

        <!-- Calendar Grid -->
        <div class="relative">
            {{ calendar|safe }}
            
            <!-- Tooltip for expense information -->
            <div id="day-tooltip" class="hidden absolute z-50 bg-gray-900 dark:bg-gray-100 text-white dark:text-gray-900 text-xs rounded-lg px-3 py-2 shadow-lg pointer-events-none">
                <div class="tooltip-content">
                    <div class="font-semibold">Loading...</div>
                </div>
                <div class="tooltip-arrow absolute w-2 h-2 bg-gray-900 dark:bg-gray-100 transform rotate-45 -bottom-1 left-1/2 -translate-x-1/2"></div>
            </div>
        </div>

        <!-- Footer Link -->
        <footer class="text-center mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
            <a href="{% url 'daily_view_today' %}" 
               class="inline-flex items-center gap-2 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors duration-200">
                <i class="fas fa-chart-line"></i>
                Go to Today's Ledger
            </a>
        </footer>
    </div>
</div>

<!-- Optimized Calendar Styling -->
<style>
    .ledger-calendar {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0.5rem;
        margin: 1rem 0;
    }
    
    .ledger-calendar th {
        padding-bottom: 0.75rem;
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
        text-align: center;
        color: rgb(107 114 128);
    }
    
    .dark .ledger-calendar th {
        color: rgb(156 163 175);
    }
    
    .ledger-calendar td {
        text-align: center;
    }
    
    .ledger-calendar td a {
        display: block;
        width: 100%;
        height: 3rem;
        padding: 0.75rem;
        border-radius: 0.5rem;
        font-weight: 500;
        font-size: 1rem;
        transition: all 0.2s ease;
        background-color: rgb(249 250 251);
        color: rgb(31 41 55);
        border: 1px solid transparent;
    }
    
    .dark .ledger-calendar td a {
        background-color: rgb(55 65 81);
        color: rgb(229 231 235);
    }
    
    .ledger-calendar td a:hover {
        background-color: rgb(59 130 246);
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    
    .ledger-calendar .noday {
        pointer-events: none;
        opacity: 0;
    }
</style>

<!-- Tooltip and Calendar JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tooltip = document.getElementById('day-tooltip');
    const tooltipContent = tooltip.querySelector('.tooltip-content');
    let hoverTimeout;

    // Add event listeners to all calendar day links
    document.querySelectorAll('.calendar-day-link').forEach(link => {
        link.addEventListener('mouseenter', function(e) {
            clearTimeout(hoverTimeout);
            
            const year = this.dataset.year;
            const month = this.dataset.month;
            const day = this.dataset.day;
            
            // Position tooltip
            const rect = this.getBoundingClientRect();
            const containerRect = this.closest('.relative').getBoundingClientRect();
            
            tooltip.style.left = (rect.left - containerRect.left + rect.width / 2) + 'px';
            tooltip.style.top = (rect.top - containerRect.top - 10) + 'px';
            tooltip.style.transform = 'translateX(-50%) translateY(-100%)';
            
            // Show tooltip with loading state
            tooltipContent.innerHTML = '<div class="font-semibold">Loading...</div>';
            tooltip.classList.remove('hidden');
            
            // Fetch day summary
            fetch(`/api/day-summary/?year=${year}&month=${month}&day=${day}`)
                .then(response => response.json())
                .then(data => {
                    let statusColor = 'text-gray-400';
                    if (data.status === 'Balanced') statusColor = 'text-green-400';
                    else if (data.status === 'Underspent') statusColor = 'text-blue-400';
                    else if (data.status === 'Overspent') statusColor = 'text-red-400';
                    
                    tooltipContent.innerHTML = `
                        <div class="font-semibold mb-1">₱${data.total_expenses.toFixed(2)} spent</div>
                        <div class="text-xs">Budget: ₱${data.effective_budget.toFixed(2)}</div>
                        <div class="text-xs">Remaining: ₱${data.remaining_budget.toFixed(2)}</div>
                        <div class="text-xs ${statusColor}">${data.status}</div>
                    `;
                })
                .catch(error => {
                    console.error('Error fetching day summary:', error);
                    tooltipContent.innerHTML = '<div class="text-xs">No data available</div>';
                });
        });
        
        link.addEventListener('mouseleave', function() {
            hoverTimeout = setTimeout(() => {
                tooltip.classList.add('hidden');
            }, 100);
        });
    });
    
    // Hide tooltip when hovering over it
    tooltip.addEventListener('mouseenter', function() {
        clearTimeout(hoverTimeout);
    });
    
    tooltip.addEventListener('mouseleave', function() {
        tooltip.classList.add('hidden');
    });
});
</script>
{% endblock %}